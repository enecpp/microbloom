@namespace microbloom.Pages
@page "/"
@page "/jobs"

@using microbloom.DTOs
@using Microsoft.AspNetCore.Components.Authorization
@inject HttpClient Http
@inject NavigationManager NavigationManager

<PageTitle>?? Ýþ Ýlanlarý - microbloom</PageTitle>

<div class="container my-5">
    <!-- ?? Arama Bölümü - Yuvarlak ve Modern -->
    <div class="row mb-5">
        <div class="col-md-12">
     <div class="card shadow border-0">
      <div class="card-body p-4">
           <h2 class="mb-4 text-center">
      <span style="font-size: 2rem;">??</span> Ýþ Fýrsatlarýný Keþfet
   </h2>
         
<div class="row g-3 align-items-end">
           <div class="col-md-5">
         <label class="form-label fw-bold">
     ?? Pozisyon Ara...
         </label>
                  <div class="input-group" style="border-radius: 2rem; overflow: hidden; border: 2px solid var(--theme-border);">
    <span class="input-group-text bg-white border-0" style="padding-left: 1.25rem;">
          <i class="bi bi-briefcase" style="color: var(--theme-primary);"></i>
            </span>
<input type="text" 
         class="form-control border-0" 
    placeholder="Geliþtirici, Tasarýmcý, Yönetici..." 
               style="padding: 0.75rem 1.25rem;"
@bind="searchKeyword" 
           @onkeyup="HandleKeyPress" />
            </div>
          </div>
  
         <div class="col-md-5">
  <label class="form-label fw-bold">
   ?? Lokasyon...
        </label>
       <div class="input-group" style="border-radius: 2rem; overflow: hidden; border: 2px solid var(--theme-border);">
     <span class="input-group-text bg-white border-0" style="padding-left: 1.25rem;">
    <i class="bi bi-geo-alt" style="color: var(--theme-primary);"></i>
    </span>
        <input type="text" 
   class="form-control border-0" 
   placeholder="Ýstanbul, Ankara, Uzaktan..." 
        style="padding: 0.75rem 1.25rem;"
@bind="searchLocation" 
         @onkeyup="HandleKeyPress" />
        </div>
</div>
            
    <div class="col-md-2">
             <button class="btn btn-primary w-100" @onclick="PerformSearch" style="padding: 0.875rem;">
             ?? Ara
 </button>
     </div>
        </div>

          @if (!string.IsNullOrWhiteSpace(searchKeyword) || !string.IsNullOrWhiteSpace(searchLocation))
        {
      <div class="mt-3 text-center">
             <button class="btn btn-outline-primary btn-sm" @onclick="ResetSearch">
             <i class="bi bi-arrow-counterclockwise"></i> Sýfýrla
     </button>
    </div>
      }
</div>
   </div>
        </div>
    </div>

    <!-- ?? Ýlanlar Listeleme -->
  <div class="row">
        <div class="col-md-12">
@if (jobList == null)
            {
           <div class="text-center py-5">
   <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;" role="status">
    <span class="visually-hidden">Yükleniyor...</span>
        </div>
        <p class="text-muted">? Ýlanlar yükleniyor...</p>
   </div>
         }
 else if (!jobList.Any())
 {
           <div class="card shadow-sm text-center border-0">
       <div class="card-body py-5">
                 <div style="font-size: 5rem; margin-bottom: 1.5rem;">??</div>
       <h3 class="mb-3">Aradýðýnýz Kriterlere Uygun Ýlan Bulunamadý</h3>
 <p class="text-muted mb-4">Arama kriterlerinizi deðiþtirerek tekrar deneyin veya tüm ilanlarý görüntüleyin.</p>
            <button class="btn btn-primary btn-lg" @onclick="ResetSearch">
          ?? Tüm Ýlanlarý Göster
     </button>
        </div>
     </div>
  }
      else
  {
  <div class="row mb-4 align-items-center">
       <div class="col-md-6">
     <h3 class="mb-0">
      ?? Aktif Ýþ Ýlanlarý
            <span class="badge bg-primary ms-2">@jobList.Count</span>
      </h3>
   </div>
         <div class="col-md-6 text-md-end">
    <small class="text-muted">
            ?? @jobList.Count adet aktif iþ ilaný bulundu
    </small>
     </div>
       </div>

      <div class="row g-4">
      @foreach (var job in jobList)
      {
            <div class="col-md-6 col-lg-4">
            <div class="card h-100 shadow-sm interactive-card job-card">
            <div class="card-body">
        <div class="d-flex justify-content-between align-items-start mb-3">
      <div class="flex-grow-1">
               <h5 class="card-title mb-2" style="color: var(--theme-text-primary); font-weight: 700;">
         ?? @job.Title
     </h5>
 <p class="card-subtitle text-primary mb-0 fw-semibold">
   ?? @job.CompanyName
           </p>
   </div>
       <small class="text-muted text-nowrap ms-2">
    ??? @job.PostedDate.ToShortDateString()
         </small>
          </div>

              <p class="small text-muted mb-3">
                   ?? @job.Location
          </p>

        <p class="card-text small" style="max-height: 85px; overflow: hidden; text-overflow: ellipsis; line-height: 1.6; color: var(--theme-text-secondary);">
      @job.Description
     </p>
           </div>
            <div class="card-footer bg-white border-top-0">
       <a href="/job/@job.Id" class="btn btn-primary w-100">
         <i class="bi bi-eye"></i> Detaylarý Gör
              </a>
             </div>
      </div>
                 </div>
    }
    </div>
            }
        </div>
    </div>
</div>

@code {
    private List<JobPostingDto>? jobList;
    private string searchKeyword = string.Empty;
    private string searchLocation = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await LoadJobs();
    }

    private async Task LoadJobs()
    {
   try
        {
      jobList = await Http.GetFromJsonAsync<List<JobPostingDto>>("api/jobpostings");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Ýlanlarý çekerken hata oluþtu: {ex.Message}");
jobList = new List<JobPostingDto>();
        }
    }

    private async Task PerformSearch()
    {
        try
        {
       if (string.IsNullOrWhiteSpace(searchKeyword) && string.IsNullOrWhiteSpace(searchLocation))
            {
          await LoadJobs();
      return;
            }

     var keyword = Uri.EscapeDataString(searchKeyword ?? string.Empty);
       var location = Uri.EscapeDataString(searchLocation ?? string.Empty);

            jobList = await Http.GetFromJsonAsync<List<JobPostingDto>>($"api/jobpostings/search?keyword={keyword}&location={location}");
        }
        catch (Exception ex)
        {
       Console.WriteLine($"Arama sýrasýnda hata oluþtu: {ex.Message}");
         jobList = new List<JobPostingDto>();
 }
    }

    private async Task ResetSearch()
    {
        searchKeyword = string.Empty;
        searchLocation = string.Empty;
        await LoadJobs();
    }

    private async Task HandleKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
         await PerformSearch();
        }
    }
}