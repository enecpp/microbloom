@namespace microbloom.Pages
@page "/account/login"
@using microbloom.Services.Interfaces
@using microbloom.DTOs
@inject IAuthService AuthService
@inject NavigationManager NavigationManager

<PageTitle>Giriþ Yap</PageTitle>

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-5">
        <div class="card shadow">
 <div class="card-body">
         <h2 class="card-title mb-4">Giriþ Yap</h2>

        @if (!string.IsNullOrEmpty(errorMessage))
        {
             <div class="alert alert-danger alert-dismissible fade show" role="alert">
           @errorMessage
     <button type="button" class="btn-close" @onclick="() => errorMessage = string.Empty"></button>
           </div>
   }

      <EditForm Model="loginDto" OnValidSubmit="HandleLogin">
          <DataAnnotationsValidator />
    <ValidationSummary class="alert alert-warning" />

         <div class="mb-3">
          <label for="email" class="form-label">E-posta</label>
       <InputText id="email" class="form-control" placeholder="ornek@example.com" @bind-Value="loginDto.Email" />
    <ValidationMessage For="@(() => loginDto.Email)" />
      </div>

      <div class="mb-3">
      <label for="password" class="form-label">Þifre</label>
     <InputText id="password" type="password" class="form-control" placeholder="Þifrenizi girin" @bind-Value="loginDto.Password" />
          <ValidationMessage For="@(() => loginDto.Password)" />
           </div>

 <button type="submit" class="btn btn-primary w-100" disabled="@isSubmitting">
       @if (isSubmitting)
        {
      <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
    <span>Giriþ Yapýlýyor...</span>
        }
     else
     {
           <span>Giriþ Yap</span>
     }
</button>

              <p class="mt-3 text-center">
         Hesabýn yok mu? <a href="/account/register" class="text-decoration-none">Kayýt Ol</a>
    </p>
      </EditForm>
         </div>
  </div>
        </div>
    </div>
</div>

@code {
    private LoginDto loginDto = new();
    private string errorMessage = string.Empty;
private bool isSubmitting = false;

    private async Task HandleLogin()
    {
      try
     {
            isSubmitting = true;
  errorMessage = string.Empty;

        var result = await AuthService.LoginAsync(loginDto);
            if (result.Successful)
            {
    NavigationManager.NavigateTo("/");
            }
 else
  {
      errorMessage = result.Error ?? "Giriþ sýrasýnda bir hata oluþtu.";
            }
      }
        catch (Exception ex)
        {
errorMessage = $"Hata: {ex.Message}";
        }
        finally
     {
            isSubmitting = false;
        }
    }
}
