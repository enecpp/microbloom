@namespace microbloom.Pages
@page "/employer/dashboard"
@using microbloom.DTOs
@using Microsoft.AspNetCore.Components.Authorization
@inject HttpClient Http
@inject NavigationManager NavigationManager

<PageTitle>?? Employer Dashboard - microbloom</PageTitle>

<AuthorizeView Context="authContext">
    <Authorized>
        <div class="container my-5">
       <div class="row mb-5">
                <div class="col-md-12">
       <div class="d-flex justify-content-between align-items-start">
             <div>
    <h1 class="display-5 mb-2">
        <i class="bi bi-briefcase"></i> ?? Employer Dashboard
    </h1>
      <p class="lead text-muted">
      Þirketinizin iþ ilanlarýný ve baþvurularý yönetin
          </p>
   </div>
 <button class="btn btn-primary btn-lg" @onclick="ShowCreateJobForm">
   <i class="bi bi-plus-circle"></i> ?? Yeni Ýlan Oluþtur
        </button>
      </div>
        </div>
  </div>

     @if (showCreateForm)
            {
 <div class="row mb-5">
      <div class="col-md-8">
        <div class="card shadow-lg border-0">
               <div class="card-body p-4">
     <h5 class="card-title mb-4">
      <i class="bi bi-plus-circle"></i> Yeni Ýþ Ýlaný Oluþtur
     </h5>

       @if (!string.IsNullOrEmpty(successMessage))
       {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
          <i class="bi bi-check-circle"></i> @successMessage
              <button type="button" class="btn-close" @onclick="() => successMessage = string.Empty"></button>
        </div>
        }

          @if (!string.IsNullOrEmpty(errorMessage))
         {
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
    <i class="bi bi-exclamation-circle"></i> @errorMessage
     <button type="button" class="btn-close" @onclick="() => errorMessage = string.Empty"></button>
         </div>
        }

            <EditForm Model="newJob" OnValidSubmit="CreateJobPosting" Context="formContext">
     <DataAnnotationsValidator />
      <ValidationSummary class="alert alert-warning" />

              <div class="mb-3">
    <label for="title" class="form-label fw-bold">?? Ýþ Baþlýðý</label>
     <InputText id="title" class="form-control" @bind-Value="newJob.Title" placeholder="Örn: Kýdemli .NET Geliþtirici" />
     <ValidationMessage For="@(() => newJob.Title)" />
         </div>

       <div class="mb-3">
      <label for="description" class="form-label fw-bold">?? Ýþ Tanýmý</label>
 <InputTextArea id="description" class="form-control" rows="6" @bind-Value="newJob.Description" placeholder="Ýþ açýklamasý, gereklilikler, beklentiler..." />
<ValidationMessage For="@(() => newJob.Description)" />
            </div>

             <div class="mb-4">
        <label for="location" class="form-label fw-bold">?? Lokasyon</label>
        <InputText id="location" class="form-control" @bind-Value="newJob.Location" placeholder="Örn: Ýstanbul, Türkiye" />
        <ValidationMessage For="@(() => newJob.Location)" />
         </div>

         <div class="d-flex gap-2">
 <button type="submit" class="btn btn-primary" disabled="@isSubmitting">
        @if (isSubmitting)
             {
        <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
     <span>Oluþturuluyor...</span>
}
             else
             {
     <span><i class="bi bi-check"></i> Oluþtur</span>
 }
            </button>
           <button type="button" class="btn btn-outline-secondary" @onclick="() => showCreateForm = false">Ýptal</button>
         </div>
              </EditForm>
            </div>
     </div>
           </div>
    </div>
            }

     <div class="row">
     <div class="col-md-12">
    @if (jobPostings == null)
       {
        <div class="text-center py-5">
          <div class="spinner-border text-primary mb-3" role="status">
           <span class="visually-hidden">Yükleniyor...</span>
   </div>
        <p class="text-muted">? Ýlanlarýnýz yükleniyor...</p>
              </div>
               }
                    else if (!jobPostings.Any())
      {
       <div class="card shadow-sm border-0 text-center">
      <div class="card-body py-5">
<div style="font-size: 4rem; margin-bottom: 1.5rem;">??</div>
                <h3 class="card-title">Henüz Ýlan Yok</h3>
     <p class="text-muted mb-4">Henüz iþ ilaný oluþturmadýnýz. Nitelikli adaylarý bulmaya baþlayýn!</p>
   <button class="btn btn-primary btn-lg" @onclick="ShowCreateJobForm">
         <i class="bi bi-plus-circle"></i> ?? Ýlk Ýlanýmý Oluþtur
           </button>
  </div>
       </div>
      }
          else
           {
       <div class="row mb-4">
                  <div class="col-md-6">
     <h3>
         <i class="bi bi-card-list"></i> ?? Ýþ Ýlanlarým
       <span class="badge bg-primary ms-2">@jobPostings.Count</span>
         </h3>
                 </div>
           </div>

             <div class="table-responsive">
      <table class="table table-hover">
  <thead class="table-light">
      <tr>
   <th>?? Baþlýk</th>
  <th>?? Lokasyon</th>
      <th>??? Yayýn Tarihi</th>
      <th>?? Ýþlemler</th>
     </tr>
   </thead>
   <tbody>
    @foreach (var job in jobPostings)
       {
                 <tr>
      <td><strong>@job.Title</strong></td>
     <td>@job.Location</td>
        <td>@job.PostedDate.ToShortDateString()</td>
           <td>
<button class="btn btn-sm btn-outline-primary" @onclick="() => ViewApplications(job.Id)">
    <i class="bi bi-people"></i> ?? Baþvurularý Gör
        </button>
  </td>
      </tr>
     }
                 </tbody>
        </table>
          </div>
 }
                </div>
   </div>
        </div>
    </Authorized>
    <NotAuthorized>
        <div class="container my-5">
            <div class="card shadow-sm border-0">
                <div class="card-body text-center py-5">
 <div style="font-size: 3rem; margin-bottom: 1rem;">??</div>
      <h3 class="card-title">Eriþim Reddedildi</h3>
    <p class="text-muted mb-4">Bu sayfaya eriþmek için giriþ yapmanýz gerekiyor.</p>
       <a href="/account/login" class="btn btn-primary">?? Giriþ Yap</a>
      </div>
            </div>
        </div>
    </NotAuthorized>
</AuthorizeView>

@code {
    private CreateJobDto newJob = new();
    private List<JobPostingDto>? jobPostings;
    private string successMessage = string.Empty;
    private string errorMessage = string.Empty;
    private bool showCreateForm = false;
    private bool isSubmitting = false;

    protected override async Task OnInitializedAsync()
    {
     await LoadJobPostings();
    }

    private async Task LoadJobPostings()
    {
   try
        {
      var result = await Http.GetFromJsonAsync<List<JobPostingDto>>("api/employer/job-postings");
   jobPostings = result ?? new();
     }
        catch (Exception ex)
        {
            errorMessage = $"Ýlanlar yüklenmedi: {ex.Message}";
            jobPostings = new();
    }
    }

    private void ShowCreateJobForm()
    {
showCreateForm = true;
    }

  private async Task CreateJobPosting()
    {
        try
        {
        isSubmitting = true;
         errorMessage = string.Empty;
            successMessage = string.Empty;

   var response = await Http.PostAsJsonAsync("api/employer/job-postings", newJob);

            if (response.IsSuccessStatusCode)
    {
            successMessage = "Ýþ ilaný baþarýyla oluþturuldu! ??";
   newJob = new CreateJobDto();
    showCreateForm = false;
                await Task.Delay(1000);
    await LoadJobPostings();
      }
            else
    {
                var error = await response.Content.ReadAsStringAsync();
  errorMessage = $"Hata: {error}";
            }
  }
        catch (Exception ex)
        {
      errorMessage = $"Hata: {ex.Message}";
        }
        finally
        {
            isSubmitting = false;
        }
    }

    private void ViewApplications(int jobId)
    {
        NavigationManager.NavigateTo($"/employer/applications/{jobId}");
    }
}
