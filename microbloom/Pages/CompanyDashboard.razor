@namespace microbloom.Pages
@page "/company-dashboard"
@attribute [Microsoft.AspNetCore.Authorization.Authorize(Roles = "Employer")]

@using microbloom.DTOs
@inject HttpClient Http
@inject NavigationManager NavigationManager

<PageTitle>🏢 Şirket Paneli - microbloom</PageTitle>

<div class="container my-5">
  <div class="row mb-5">
    <div class="col-12">
      <div class="d-flex flex-column flex-lg-row justify-content-between align-items-lg-center gap-3">
        <div>
          <h1 class="display-5 mb-2">🏢 Şirket Panelim</h1>
          <p class="lead text-muted mb-0">Mevcut ilanlarınızı yönetin, başvuruları takip edin ve şirket profilinizi güncel tutun.</p>
        </div>
        <button class="btn btn-primary btn-lg" @onclick="GoToCreateJobPage">
          <i class="bi bi-plus-circle"></i> 🚀 Yeni İlan Oluştur
        </button>
      </div>
    </div>
  </div>

  <div class="row g-4 mb-5">
    <div class="col-lg-4">
      <div class="card h-100 shadow-sm border-0">
        <div class="card-body">
          @if (isProfileLoading)
          {
            <div class="text-center py-4">
              <div class="spinner-border text-primary mb-3" role="status"></div>
              <p class="text-muted mb-0">Profil bilgileriniz yükleniyor...</p>
            </div>
          }
          else if (companyProfile != null)
          {
            <div class="d-flex align-items-center gap-3 mb-3">
              @if (!string.IsNullOrWhiteSpace(companyProfile.LogoUrl))
              {
                <img src="@companyProfile.LogoUrl" class="rounded" style="width: 64px; height: 64px; object-fit: contain;" alt="Şirket logosu" />
              }
              else
              {
                <div class="d-flex align-items-center justify-content-center rounded bg-light" style="width: 64px; height: 64px; font-size: 1.75rem;">
                  🏢
                </div>
              }

              <div>
                <h4 class="mb-1">@(!string.IsNullOrWhiteSpace(companyProfile.Name) ? companyProfile.Name : "Şirket Adı Tanımlanmamış")</h4>
                <span class="badge bg-primary-subtle text-primary">Employer</span>
              </div>
            </div>

            <p class="text-muted small mb-4">
              @(!string.IsNullOrWhiteSpace(companyProfile.Description)
                ? companyProfile.Description
                : "Şirket profilinizi güncelleyerek adaylara kendinizi tanıtın.")
            </p>

            <div class="d-flex gap-4">
              <div>
                <div class="fw-bold fs-4">@companyProfile.EmployeeCount</div>
                <div class="text-muted small">Ekip üyesi</div>
              </div>
              <div>
                <div class="fw-bold fs-4">@companyProfile.ActiveJobCount</div>
                <div class="text-muted small">Aktif ilan</div>
              </div>
            </div>
          }
          else
          {
            <div class="alert alert-warning mb-0" role="alert">
              Şirket profili yüklenemedi. Lütfen sayfayı yenileyin.
            </div>
          }
        </div>
      </div>
    </div>

    <div class="col-lg-8">
      <div class="card shadow-sm border-0">
        <div class="card-body p-4">
          <h3 class="h5 mb-3"><i class="bi bi-pencil-square me-2"></i> Şirket Profilini Güncelle</h3>

          @if (!string.IsNullOrEmpty(profileStatusMessage))
          {
            <div class="@ProfileStatusCss mb-3" role="alert">
              @profileStatusMessage
            </div>
          }

          @if (isProfileLoading)
          {
            <div class="text-center py-4">
              <div class="spinner-border text-primary mb-3" role="status"></div>
              <p class="text-muted mb-0">Profil formu hazırlanıyor...</p>
            </div>
          }
          else
          {
            <EditForm Model="companyProfile" OnValidSubmit="SaveCompanyProfileAsync">
              <DataAnnotationsValidator />
              <ValidationSummary class="alert alert-warning" />

              <div class="mb-3">
                <label for="company-name" class="form-label fw-semibold">Şirket Adı</label>
                <InputText id="company-name" class="form-control" @bind-Value="companyProfile!.Name" />
                <ValidationMessage For="@(() => companyProfile!.Name)" class="text-danger small" />
              </div>

              <div class="mb-3">
                <label for="company-description" class="form-label fw-semibold">Şirket Açıklaması</label>
                <InputTextArea id="company-description" class="form-control" rows="5" @bind-Value="companyProfile!.Description" />
                <ValidationMessage For="@(() => companyProfile!.Description)" class="text-danger small" />
              </div>

              <div class="mb-4">
                <label for="company-logo" class="form-label fw-semibold">Logo Adresi (URL)</label>
                <InputText id="company-logo" class="form-control" @bind-Value="companyProfile!.LogoUrl" placeholder="https://..." />
                <ValidationMessage For="@(() => companyProfile!.LogoUrl)" class="text-danger small" />
              </div>

              <div class="d-flex flex-column flex-sm-row gap-3">
                <button type="submit" class="btn btn-primary" disabled="@isSavingProfile">
                  @if (isSavingProfile)
                  {
                    <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                    <span>Kaydediliyor...</span>
                  }
                  else
                  {
                    <span>💾 Değişiklikleri Kaydet</span>
                  }
                </button>
                <button type="button" class="btn btn-outline-secondary" @onclick="ReloadCompanyProfileAsync" disabled="@isSavingProfile || isProfileLoading">
                  <i class="bi bi-arrow-clockwise"></i> Yenile
                </button>
              </div>
            </EditForm>
          }
        </div>
      </div>
    </div>
  </div>

  @if (myJobs == null)
  {
    <div class="text-center py-5">
      <div class="spinner-border text-primary mb-3" role="status"></div>
      <p class="text-muted">⏳ İlanlarınız yükleniyor...</p>
    </div>
  }
  else if (!myJobs.Any())
  {
    <div class="card shadow-sm border-0 text-center">
      <div class="card-body py-5">
        <div style="font-size: 4rem; margin-bottom: 1.5rem;">📭</div>
        <h3 class="card-title">Henüz İlan Yok</h3>
        <p class="text-muted mb-4">Henüz hiç iş ilanınız bulunmuyor. İlk ilanınızı oluşturup nitelikli adayları bulmaya başlayın!</p>
        <button class="btn btn-primary btn-lg" @onclick="GoToCreateJobPage">
          <i class="bi bi-plus-circle"></i> 🚀 İlk İlanımı Oluştur
        </button>
      </div>
    </div>
  }
  else
  {
    <div class="row mb-4 align-items-center">
      <div class="col-md-6">
        <h3 class="mb-0">
          <i class="bi bi-card-list"></i> 📋 Aktif İlanlarım
          <span class="badge bg-primary ms-2">@myJobs.Count</span>
        </h3>
      </div>
      <div class="col-md-6 text-md-end">
        <small class="text-muted">💡 Tüm aktif iş ilanlarınız aşağıda listelenmiştir</small>
      </div>
    </div>

    <div class="row g-4">
      @foreach (var job in myJobs)
      {
        <div class="col-md-6 col-lg-4">
          <div class="card h-100 shadow-sm border-0">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-start mb-3">
                <div class="flex-grow-1">
                  <h5 class="card-title mb-1">📄 @job.Title</h5>
                  <p class="card-subtitle text-primary mb-2">🏢 @job.CompanyName</p>
                </div>
                <span class="badge bg-success">✅ Aktif</span>
              </div>

              <p class="small text-muted mb-2">📍 @job.Location</p>
              <p class="card-text small" style="max-height: 80px; overflow: hidden; text-overflow: ellipsis; line-height: 1.5;">
                @job.Description
              </p>
              <p class="small text-muted mt-3">🗓️ Yayınlandı: @job.PostedDate.ToShortDateString()</p>
            </div>

            <div class="card-footer bg-light border-top">
              <div class="d-grid gap-2">
                <button class="btn btn-primary btn-sm" @onclick="() => ViewApplications(job.Id)">
                  <i class="bi bi-people"></i> 👥 Başvuruları Gör
                </button>
                <div class="btn-group" role="group">
                  <button class="btn btn-warning btn-sm" @onclick="() => DeactivateJob(job.Id)" disabled="@isProcessing" title="İlanı pasif yap">
                    @if (isProcessing && processingJobId == job.Id)
                    {
                      <span class="spinner-border spinner-border-sm"></span>
                    }
                    else
                    {
                      <i class="bi bi-pause-circle"></i>
                    }
                  </button>
                  <button class="btn btn-danger btn-sm" @onclick="() => ConfirmDelete(job.Id)" disabled="@isProcessing" title="İlanı sil">
                    @if (isProcessing && processingJobId == job.Id)
                    {
                      <span class="spinner-border spinner-border-sm"></span>
                    }
                    else
                    {
                      <i class="bi bi-trash"></i>
                    }
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      }
    </div>
  }
</div>

@code {
  private List<JobPostingDto>? myJobs;
  private CompanyProfileDto companyProfile = new();
  private bool isProfileLoading = true;
  private bool isSavingProfile;
  private bool profileSaveSuccess;
  private string profileStatusMessage = string.Empty;
  private bool isProcessing;
  private int? processingJobId;
  private int? jobToDelete;

  protected override async Task OnInitializedAsync()
  {
    await LoadCompanyProfileAsync();
    await LoadCompanyJobsAsync();
  }

  private async Task LoadCompanyProfileAsync()
  {
    try
    {
      isProfileLoading = true;
      profileStatusMessage = string.Empty;

      var profile = await Http.GetFromJsonAsync<CompanyProfileDto>("api/company/profile");
      companyProfile = profile ?? new CompanyProfileDto();
    }
    catch (Exception ex)
    {
      Console.WriteLine($"Şirket profili çekilirken hata: {ex.Message}");
      companyProfile = new CompanyProfileDto();
      profileStatusMessage = "Şirket profili yüklenemedi.";
      profileSaveSuccess = false;
    }
    finally
    {
      isProfileLoading = false;
    }
  }

  private async Task ReloadCompanyProfileAsync()
  {
    await LoadCompanyProfileAsync();
    StateHasChanged();
  }

  private async Task SaveCompanyProfileAsync()
  {
    try
    {
      isSavingProfile = true;
      profileStatusMessage = string.Empty;
      profileSaveSuccess = false;

      var response = await Http.PutAsJsonAsync("api/company/profile", companyProfile);

      if (response.IsSuccessStatusCode)
      {
        profileSaveSuccess = true;
        profileStatusMessage = "Profil başarıyla güncellendi.";

        var refreshed = await Http.GetFromJsonAsync<CompanyProfileDto>("api/company/profile");
        if (refreshed != null)
        {
          companyProfile.Name = refreshed.Name;
          companyProfile.Description = refreshed.Description;
          companyProfile.LogoUrl = refreshed.LogoUrl;
          companyProfile.EmployeeCount = refreshed.EmployeeCount;
          companyProfile.ActiveJobCount = refreshed.ActiveJobCount;
        }
      }
      else
      {
        var error = await response.Content.ReadAsStringAsync();
        profileStatusMessage = $"Profil güncellenemedi: {error}";
      }
    }
    catch (Exception ex)
    {
      profileStatusMessage = $"Hata: {ex.Message}";
    }
    finally
    {
      isSavingProfile = false;
    }
  }

  private string ProfileStatusCss => profileSaveSuccess ? "alert alert-success" : "alert alert-danger";

  private async Task LoadCompanyJobsAsync()
  {
    try
    {
      myJobs = await Http.GetFromJsonAsync<List<JobPostingDto>>("api/company/jobs");
    }
    catch (Exception ex)
    {
      Console.WriteLine($"Şirket ilanları çekilirken hata: {ex.Message}");
      myJobs = new List<JobPostingDto>();
    }
  }

  private void ViewApplications(int jobId)
  {
    NavigationManager.NavigateTo($"/company/job/{jobId}/applications");
  }

  private void GoToCreateJobPage()
  {
    NavigationManager.NavigateTo("/company/create-job");
  }

  private async Task DeactivateJob(int jobId)
  {
    if (!await ConfirmAction("Bu ilanı pasif yapmak istediğinizden emin misiniz?"))
      return;

    try
    {
      isProcessing = true;
      processingJobId = jobId;
      StateHasChanged();

      var response = await Http.PutAsync($"api/company/jobs/{jobId}/deactivate", null);

      if (response.IsSuccessStatusCode)
      {
        await LoadCompanyJobsAsync();
        await LoadCompanyProfileAsync();
      }
      else
      {
        var error = await response.Content.ReadAsStringAsync();
        Console.WriteLine($"İlan pasif yapılamadı: {error}");
      }
    }
    catch (Exception ex)
    {
      Console.WriteLine($"Hata: {ex.Message}");
    }
    finally
    {
      isProcessing = false;
      processingJobId = null;
      StateHasChanged();
    }
  }

  private void ConfirmDelete(int jobId)
  {
    jobToDelete = jobId;
    StateHasChanged();
  }

  private async Task DeleteJob(int jobId)
  {
    if (!await ConfirmAction("Bu ilanı kalıcı olarak silmek istediğinizden emin misiniz? Bu işlem geri alınamaz!"))
      return;

    try
    {
      isProcessing = true;
      processingJobId = jobId;
      StateHasChanged();

      var response = await Http.DeleteAsync($"api/company/jobs/{jobId}");

      if (response.IsSuccessStatusCode)
      {
        await LoadCompanyJobsAsync();
        await LoadCompanyProfileAsync();
      }
      else
      {
        var error = await response.Content.ReadAsStringAsync();
        Console.WriteLine($"İlan silinemedi: {error}");
      }
    }
    catch (Exception ex)
    {
      Console.WriteLine($"Hata: {ex.Message}");
    }
    finally
    {
      isProcessing = false;
      processingJobId = null;
      StateHasChanged();
    }
  }

  private async Task<bool> ConfirmAction(string message)
  {
    // TODO: IJSRuntime ile gerçek onay diyaloğu ekle
    await Task.CompletedTask;
    return true;
  }
}