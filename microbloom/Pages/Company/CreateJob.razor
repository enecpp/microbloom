@namespace microbloom.Pages
@page "/company/create-job"
@attribute [Microsoft.AspNetCore.Authorization.Authorize(Roles = "Employer")]

@using microbloom.DTOs
@inject HttpClient Http
@inject NavigationManager NavigationManager

<PageTitle>?? Yeni Ýlan Oluþtur - microbloom</PageTitle>

<div class="container my-5">
    <div class="row justify-content-center">
 <div class="col-md-8">
       <div class="card shadow-lg border-0">
<div class="card-body p-5">
      <div class="d-flex align-items-center mb-4 pb-3" style="border-bottom: 2px solid var(--theme-border);">
 <div style="font-size: 3rem; margin-right: 1rem;">??</div>
    <div>
 <h2 class="mb-1" style="font-weight: 800; color: var(--theme-primary);">Yeni Ýþ Ýlaný Oluþtur</h2>
     <p class="text-muted small mb-0">Nitelikli adaylarý bul ve ekibini güçlendir</p>
     </div>
  </div>

    @if (!string.IsNullOrEmpty(errorMessage))
       {
  <div class="alert alert-danger d-flex align-items-start" role="alert">
      <i class="bi bi-exclamation-triangle me-2" style="font-size: 1.5rem;"></i>
      <div>@errorMessage</div>
        </div>
     }

        @if (!string.IsNullOrEmpty(successMessage))
   {
       <div class="alert alert-success d-flex align-items-start" role="alert">
       <i class="bi bi-check-circle me-2" style="font-size: 1.5rem;"></i>
    <div>@successMessage</div>
 </div>
  }

 <EditForm Model="createJobDto" OnValidSubmit="HandleCreateJob">
     <DataAnnotationsValidator />
    <ValidationSummary class="alert alert-warning" />

  <div class="mb-4">
    <label for="title" class="form-label fw-bold">
 ?? Ýlan Baþlýðý
       </label>
        <InputText id="title"
   class="form-control"
        placeholder="Örn: Kýdemli .NET Geliþtirici, Proje Yöneticisi, UX Tasarýmcý"
    @bind-Value="createJobDto.Title" />
   <ValidationMessage For="@(() => createJobDto.Title)" class="text-danger small" />
  <small class="form-text text-muted d-block mt-1">
     ?? Açýk ve ilgi çekici bir baþlýk kullanýn
   </small>
     </div>

          <div class="mb-4">
  <label for="location" class="form-label fw-bold">
 ?? Lokasyon
  </label>
      <InputText id="location"
  class="form-control"
  placeholder="Örn: Ýstanbul, Türkiye | Uzaktan | Hibrit"
       @bind-Value="createJobDto.Location" />
   <ValidationMessage For="@(() => createJobDto.Location)" class="text-danger small" />
    </div>

         <div class="mb-4">
     <label for="description" class="form-label fw-bold">
  ?? Ýþ Tanýmý
        </label>
      <InputTextArea id="description"
 class="form-control"
rows="12"
    placeholder="Pozisyon gereksinimleri, beklentiler, þirket kültürü ve kariyer geliþim fýrsatlarý hakkýnda detaylý bilgi verin..."
 style="line-height: 1.8;"
     @bind-Value="createJobDto.Description" />
     <ValidationMessage For="@(() => createJobDto.Description)" class="text-danger small" />
      <small class="form-text text-muted d-block mt-1">
 ?? Ne kadar detaylý olursanýz, o kadar nitelikli adaylarý çekersiniz
    </small>
  </div>

      <div class="d-grid gap-3 d-md-flex justify-content-md-between mt-5 pt-3" style="border-top: 2px solid var(--theme-border);">
    <button type="button" class="btn btn-outline-secondary" @onclick="NavigateBack">
      <i class="bi bi-arrow-left"></i> Geri Dön
 </button>
      <button type="submit" class="btn btn-primary btn-lg px-5" disabled="@isSubmitting">
   @if (isSubmitting)
   {
      <span class="spinner-border spinner-border-sm me-2" role="status"></span>
    <span>Ýlan yayýnlanýyor...</span>
  }
           else
  {
      <span>?? Ýlaný Yayýnla</span>
 }
  </button>
   </div>
     </EditForm>
   </div>
   </div>
  </div>
    </div>
</div>

@code {
  private CreateJobDto createJobDto = new();
    private string errorMessage = string.Empty;
    private string successMessage = string.Empty;
    private bool isSubmitting = false;

 private async Task HandleCreateJob()
{
        try
        {
          isSubmitting = true;
       errorMessage = string.Empty;
          successMessage = string.Empty;

       var response = await Http.PostAsJsonAsync("api/company/jobs", createJobDto);

       if (response.IsSuccessStatusCode)
{
     successMessage = "Ýlan baþarýyla oluþturuldu! ?? Yönlendiriliyorsunuz...";
    await Task.Delay(1500);
     NavigationManager.NavigateTo("/company-dashboard");
      }
   else
  {
   var error = await response.Content.ReadAsStringAsync();
     errorMessage = $"Ýlan oluþturulamadý: {error}";
 }
  }
 catch (Exception ex)
{
   errorMessage = $"Hata: {ex.Message}";
 }
 finally
 {
          isSubmitting = false;
    }
    }

    private void NavigateBack()
  {
 NavigationManager.NavigateTo("/company-dashboard");
    }
}
